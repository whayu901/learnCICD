---
jobs:
  android-alpha:
    docker:
      - image: "circleci/android:api-29-node"
    steps:
      - checkout:
          path: ~/demo-react-native
      - attach_workspace:
          at: ~/demo-react-native
      - restore_cache:
          key: 'bundle-v1-{{ checksum "Gemfile.lock" }}-{{ arch }}'
      - run: "bundle install"
      - save_cache:
          key: 'bundle-v1-{{ checksum "Gemfile.lock" }}-{{ arch }}'
          paths:
            - vendor/bundle
      - run:
          command: "cd android; bundle exec fastlane alpha\n"
          name: "fastlane android alpha"
      - store_artifacts:
          path: app/build/outputs/apk/release/app-release.apk
    working_directory: ~/demo-react-native/android
  android-beta:
    docker:
      - image: "circleci/android:api-29-node"
    steps:
      - checkout:
          path: ~/demo-react-native
      - attach_workspace:
          at: ~/demo-react-native
      - restore_cache:
          key: 'bundle-v1-{{ checksum "Gemfile.lock" }}-{{ arch }}'
      - run: "bundle install"
      - save_cache:
          key: 'bundle-v1-{{ checksum "Gemfile.lock" }}-{{ arch }}'
          paths:
            - vendor/bundle
      - run:
          command: "cd android; bundle exec fastlane beta\n"
          name: "fastlane android beta"
    working_directory: ~/demo-react-native/android
  node:
    docker:
      - image: "cimg/node:12.16"
    steps:
      - checkout
      - restore_cache:
          key: 'npm-v1-{{ checksum "package.lock.json" }}-{{ arch }}'
      - restore_cache:
          key: 'node-v1-{{ checksum "package.json" }}-{{ arch }}'
      - run: "npm install"
      - save_cache:
          key: 'npm-v1-{{ checksum "package.lock.json" }}-{{ arch }}'
          paths:
            - ~/.cache/npm
      - save_cache:
          key: 'node-v1-{{ checksum "package.json" }}-{{ arch }}'
          paths:
            - node_modules
      - run:
          command: |
            mkdir -p test-results/jest
            npm run test
          environment:
            JEST_JUNIT_OUTPUT: test-results/jest/junit.xml
          name: "jest tests"
      - persist_to_workspace:
          paths:
            - node_modules
          root: ~/demo-react-native
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
    working_directory: ~/demo-react-native
version: 2.1
workflows:
  node-android-ios:
    jobs:
      - android-hold:
          type: approval
      - node
      - android-alpha:
          requires:
            - node
      - android-beta:
          requires:
            - android-hold
